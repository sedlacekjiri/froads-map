<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Froad Community</title>
  <style>
    body { margin:0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
    #map { height: 40%; }
    #chat { flex: 1; overflow-y: auto; padding: 8px; border-top: 1px solid #ccc; }
    .message { margin-bottom: 12px; }
    .message .meta { font-size: 12px; color: #555; }
    .message.ranger { background: #eef; padding: 6px; border-radius: 6px; }
    #form { display: flex; align-items: center; padding: 8px; border-top: 1px solid #ccc; }
    #form input[type="text"] { flex: 1; padding: 6px; margin-right: 6px; }
    #form input[type="file"] { margin-right: 6px; }
    #login, #logout { padding: 8px; margin: 8px; }
  </style>
  <!-- Include Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <button id="login">Login</button>
  <button id="logout" style="display:none;">Logout</button>
  <div id="map"></div>
  <div id="chat"></div>
  <div id="form" style="display:none;">
    <input type="text" id="msgText" placeholder="Write a message…" />
    <input type="file" id="msgImage" accept="image/*" />
    <button id="sendBtn">Send</button>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, query, orderBy,
      onSnapshot, serverTimestamp, doc, updateDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import {
      getStorage, ref as storageRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // Leaflet map
    import L from "https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.esm.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDDMNnJgtm-gK9OrVev7qmBRpaA8CAoDiM",
      authDomain: "froad-7d561.firebaseapp.com",
      projectId: "froad-7d561",
      storageBucket: "froad-7d561.appspot.com",
      messagingSenderId: "1086299585443",
      appId: "1:1086299585443:web:10bcb67effd6a89c24f816"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // UI elements
    const loginBtn = document.getElementById("login");
    const logoutBtn = document.getElementById("logout");
    const chatDiv = document.getElementById("chat");
    const formDiv = document.getElementById("form");
    const msgText = document.getElementById("msgText");
    const msgImage = document.getElementById("msgImage");
    const sendBtn = document.getElementById("sendBtn");

    let map, userMarker;
    const userMarkers = new Map(); // userId -> marker

    // Initialize map
    function initMap() {
      map = L.map("map").setView([64.0, -19.0], 5); // central Iceland
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
      }).addTo(map);
    }

    // Authentication
    loginBtn.addEventListener("click", async () => {
      const provider = new GoogleAuthProvider();
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.error("Login error:", e);
      }
    });
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      if (user) {
        loginBtn.style.display = "none";
        logoutBtn.style.display = "block";
        formDiv.style.display = "flex";
        startChatListener();
        startLocationWatcher();
      } else {
        loginBtn.style.display = "block";
        logoutBtn.style.display = "none";
        formDiv.style.display = "none";
        chatDiv.innerHTML = "";
        // remove map markers if needed
      }
    });

    // Chat & messages
    function startChatListener() {
      const q = query(collection(db, "messages"), orderBy("createdAt"));
      onSnapshot(q, snapshot => {
        chatDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const msgEl = document.createElement("div");
          msgEl.className = "message";
          if (data.role === "ranger") msgEl.classList.add("ranger");
          const who = data.displayName || "Anonymous";
          const time = data.createdAt?.toDate().toLocaleTimeString() || "";
          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${who} • ${time}${data.role === "ranger" ? " (Ranger)" : ""}`;
          msgEl.appendChild(meta);
          if (data.text) {
            const p = document.createElement("div");
            p.textContent = data.text;
            msgEl.appendChild(p);
          }
          if (data.imageUrl) {
            const img = document.createElement("img");
            img.src = data.imageUrl;
            img.style.maxWidth = "200px";
            msgEl.appendChild(img);
          }
          chatDiv.appendChild(msgEl);
        });
        // scroll to bottom
        chatDiv.scrollTop = chatDiv.scrollHeight;
      });
    }

    sendBtn.addEventListener("click", async () => {
      const user = auth.currentUser;
      if (!user) return alert("Not logged in");
      const text = msgText.value.trim();
      const imageFile = msgImage.files[0];
      let imageUrl = null;
      if (imageFile) {
        const storRef = storageRef(storage, `msgImages/${user.uid}/${Date.now()}_${imageFile.name}`);
        const snap = await uploadBytes(storRef, imageFile);
        imageUrl = await getDownloadURL(snap.ref);
      }
      await addDoc(collection(db, "messages"), {
        uid: user.uid,
        displayName: user.displayName || user.email,
        text: text || null,
        imageUrl: imageUrl,
        createdAt: serverTimestamp(),
        role: "user"  // we can override for rangers in backend or via security rules
      });
      msgText.value = "";
      msgImage.value = null;
    });

    // Location watch
    function startLocationWatcher() {
      if (!navigator.geolocation) {
        console.warn("Geolocation not supported");
        return;
      }
      navigator.geolocation.watchPosition(async pos => {
        const user = auth.currentUser;
        if (!user) return;
        const { latitude, longitude } = pos.coords;
        // Save to Firestore userLocations collection
        await updateDoc(doc(db, "userLocations", user.uid), {
          uid: user.uid,
          lat: latitude,
          lng: longitude,
          updatedAt: serverTimestamp(),
          displayName: user.displayName || user.email
        }).catch(async err => {
          // If doc doesn't exist, create it
          await addDoc(collection(db, "userLocations"), {
            uid: user.uid,
            lat: latitude,
            lng: longitude,
            updatedAt: serverTimestamp(),
            displayName: user.displayName || user.email
          });
        });
      }, err => {
        console.warn("Geo error", err);
      }, { enableHighAccuracy: true });
      // Also listen to locations
      const locQuery = query(collection(db, "userLocations"), orderBy("updatedAt"));
      onSnapshot(locQuery, snapshot => {
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          const uid = d.uid;
          const lat = d.lat;
          const lng = d.lng;
          if (!userMarkers.has(uid)) {
            const m = L.marker([lat, lng]).addTo(map);
            userMarkers.set(uid, m);
          } else {
            userMarkers.get(uid).setLatLng([lat, lng]);
          }
        });
      });
    }

    // Initialize
    initMap();
  </script>
</body>
</html>
